---
output: md_document
always_allow_html: yes
---

# Tests-for-correct-specification-of-conditional-densities

`R` implementation of [Rossi and Sekhposyan (2019)](https://doi.org/10.1016/j.jeconom.2018.07.008) by Lluc Puig Codina.

Two tests, a Kolmogorov-Smirnov test and an Cràmer-von Mises test, are implemented to assess the correct specification of rolling window conditional distribution forecasts out of sample, one and multiple steps ahead.


## Aplications to Financial Risk Management

Expected shortfall is the risk measure at the forefront of Basel III. The accuracy of expected shortfall depends on the accuracy of the predicted distributions, their left tail in fact. Therefore we might want to backtest that the left tail of the predictive distributions is well specified. Unlike Diebold (1998) the test is joint, not pointwise, and is robust to serial correlation of the probability integral transforms (multi-step-ahead forecasts).


## Test

### Input

The test is implemented in the function `RStest` which has several arguments:

- `pits`: A vector containing the probability integral transforms (predicted CDF evaluated at the realization), thus it's elements are numeric and in [0, 1]. Elements are oredered from $t = R$ to $T$, the out-of-sample set.

- `alpha`: significance level, the probability of rejecting the null hypothesis when it is true.

- `nSim`: number of simulations in the calculation of the critical values.

- `rmin`: lower quantile to be tested. Must be in [0,1] and > than `rmax`.

- `rmax`: upper quantile to be tested. Must be in [0,1] and < than `rmin`.

- `step`: must be a string, either `r print('one')` or `r print('multiple')`. The first option implements the second boostrap procedure described in Theorem 2 of Rossi and Sekhposyan (2019) to compute the critical values, while the second option implements the procedure described in Theorem 4 of Rossi and Sekhposyan (2019), which is robust to autocorrelation of the probability integral transforms (recomented for multi-step-ahead forecasts).

- `l`: Bootstrap block length. Default is set to $[P^{1/3}]$, where $[\cdot]$ denotes the floor operator, as in all Pannels, except G, of Table 3 in Rossi and Sekhposyan (2019). Although there is no guidance on how to choose `l`, results seem to be robust to alternative lengths. Boostrap block lemgth must be numeric and larger than 1.

### Output

The test outputs a list with several objects:

- `KS_P`: Kolmogorov-Smirnov statistic.

- `KS_alpha`: Kolmogorov-Smirnov critical value.

- `CvM_P`: Cràmer-von Mises statistic.

- `CvM_alpha`: Cràmer-von Mises critical value.

The null hypothesis of the correct specification of the conditional distribution can be rejected if the statistic is larger than the critical value.


### Validation

In order to show that the implementation for the one-step-ahead forecast is correct I show that the second boostrap procedure of Table 2 can reproduce tha asymptotic results in Table 1 Pannel A and the Left Tail of Panel B of Rossi and Sekhposyan (2019).

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE, results = 'asis'}
rm(list=ls())

source("RStest.R", echo = FALSE)

set.seed(1234)

pits <- rep(0.5, 500) #will set P = 100; we don't care about the statistic here since we are only interested in the critical values.

full_0.01 <- RStest(pits, alpha = 0.01, nSim = 300, rmin = 0, rmax = 1, step = "one")
full_0.05 <- RStest(pits, alpha = 0.05, nSim = 5000, rmin = 0, rmax = 1, step = "one")
full_0.1 <- RStest(pits, alpha = 0.1, nSim = 5000, rmin = 0, rmax = 1, step = "one")

left_0.01 <- RStest(pits, alpha = 0.01, nSim = 5000, rmin = 0, rmax = 0.25, step = "one")
left_0.05 <- RStest(pits, alpha = 0.05, nSim = 5000, rmin = 0, rmax = 0.25, step = "one")
left_0.1 <- RStest(pits, alpha = 0.1, nSim = 5000, rmin = 0, rmax = 0.25, step = "one")

table1 <- data.frame(c(full_0.01$KS_alpha, left_0.01$KS_alpha),
                     c(full_0.05$KS_alpha, left_0.05$KS_alpha),
                     c(full_0.10$KS_alpha, left_0.10$KS_alpha),
                     c(full_0.01$CvM_alpha, left_0.01$CvM_alpha),
                     c(full_0.05$CvM_alpha, left_0.05$CvM_alpha),
                     c(full_0.10$CvM_alpha, left_0.10$CvM_alpha))

rownames(table1) <-c("Pannel A. Tests on the whole distribution", "Pannel B. Left Tail")
colnames(table1) <-c("0.01", "0.05", "0.10", "0.01", "0.05", "0.10")

kable(table1, longtable = T, booktabs = T, caption = "Table 1. Critical Values One-Step-Ahead Forecasts") %>%
  add_header_above(c(" ", "Kolmogorov-Smirnov Test" = 3, "Cràmer-von Mises Test" = 3)) %>%
  kable_styling(latex_options = c("repeat_header"))
```

For the multiple-step-ahead forecast Rossi and Sekhposyan (2019) simply report size properties and power results, therefore you will have to trust me in the following exercise, although the code is simple and I recomend always reading it before usage. 

Assume the data comes from the following data generating process:

$$
y_t = 0.5*y_{t-1} + \eta_t
$$
where $\eta_t$ is an i.i.d t-Student distribution with $\mu = 0$, $\sigma = 1$ and degrees of freedom equal to 1. Then we are going to fit the following model: $y_t = \beta y_{t-1} + \varepsilon_t$; where $\varepsilon_t \sim \ i.i.d. \ \mathcal{N}(0, \rho)$. We will forecast two steps ahead, thus the predictive distribution is going to be: $\hat{y_t}|y_{t-2} \sim \mathcal{N}(0,(1+\hat{\beta}^2)\hat{\rho}$. Even though we can get a consistent estimate of the autoregressive parameter of $y_t$ through OLS (by assymptotic theory), we are purposefully wrongly modeling the tails. The test is for $r \in \[0, 0.25]$. The in sample size is goign to be R = 500 and the out-of-sample size is going to be P = 101.

```{r}

```

Another case important to explore is autocorrelation in the error terms, violating Assumption 2, which is needed for the one-step-ahead forcasts but

## Note

The test is set up such that one can test the null for $r \in [rmin, rmax]$  but not for say $r \in \{[0, 0.25] \cap [0.75, 1]\}$. The code is written such that it can be easily modified. The point where modifications should be introduced for this type of test are where `v` is subsettetd, line 76 for the one-step-ahead forecasts and line 108 for multiple-step-ahead forecasts.

